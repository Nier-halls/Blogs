# TCP 三次握手四次挥手
## 提纲
> * 三次握手
>   1. 三次握手的过程
>   2. 为什么需要三次握手
> * 四次挥手
>   1. 四次挥手的过程
>   2. 为什么需要四次挥手
> * 数据可靠性
>   1. 检验和
>   2. 序列+应答
>   3. 超时重传
>   4. 链接管理
>   5. 流量控制（窗口缓存）
>   6. 拥塞控制（小数据试探）

## 三次握手

### 第一次握手
Client向Server发起请求，`[ACK=0, SYN=1, sequence=0, acknowledge=0]`。其中ACK为应答标志位，SYN为握手请求标志位，acknowledge初始化数值为0（0其实是acknowledge的相对数值）

### 第二次握手
Client收到Server的相应，`[ACK=1, SYN=1, sequence=0, acknowledge=1]`。这里ACK的值为1代表服务端收到响应了；acknowledge的值为1代表Server期望下一次得到的数据序列是从1开始的（这的1也是相对数值）；另外这里从1开始是因为需要完成一个响应，避免重传时序列的错误；无法判断是新的一次握手还是失败阻塞后的握手；

### 第三次握手
Client向Server发起请求，`[ACK=1，SYN=0, sequence=1, acknowledge=1]`。此时表示Client端已经收到了之前Server统一握手的结果；这里sequence和acknowledge都增加1保证握手过程中不会因为重传而出问题；

### 如果没有三次握手或只有一次握手
Client发起请求后Server将会立即处理请求，这个时候假如Client端请求延迟阻塞，然后一次性全部发送过来。首先Client端没办法确认Server端是否收到了Client端的连接请求，其次假如Server收到请求后立即建立通道准备处理数据，并一直等待Client发来数据。这样，Server的很多资源就白白浪费掉了。

### 如果只有两次握手
Client发出的第一个连接请求报文段并没有丢失，而是在某个网络结点长时间的滞留了，以致延误到连接释放以后的某个时间才到达Server。本来这是一个早已失效的报文段。但Server收到此失效的连接请求报文段后，就误认为是Client再次发出的一个新的连接请求。于是就向Client发出确认报文段，同意建立连接。假设不采用“三次握手”，那么只要Server发出确认，新的连接就建立了。由于现在Client并没有发出建立连接的请求，因此不会理睬Server的确认，也不会向Server发送数据。但Server却以为新的运输连接已经建立，并一直等待Client发来数据。这样，Server的很多资源就白白浪费掉了。


## 四次挥手
### 第一次挥手
Client发起一次断开请求`[FIN=1]`

### 第二次挥手
Server收到Client发送的请求并进行响应`[ACK=1,FIN=1]`，此时从Client发往Server的数据通道已经断开

### 第三次挥手
Server在发送完数据后发起一次断开请求`[FIN=1]`

### 第四次挥手
Client收到Server发送的请求并进行响应`[ACK=1，FIN=1]`，此时从Server发往Client的数据通道已经断开

### 为什么有四次挥手
TCP通道是全双工通道，来往数据通道需要两次才能完全关闭，因此需要两次响应请求也就是四次请求才能完全确认关闭；

## 数据可靠性

### 校验和
计算方式：在数据传输的过程中，将发送的数据段都当做一个16位的整数。将这些整数加起来。并且前面的进位不能丢弃，补在后面，最后取反，得到校验和。

发送方：在发送数据之前计算检验和，并进行校验和的填充。

接收方：收到数据后，对数据以同样的方式进行计算，求出校验和，与发送方的进行比对。

整体类似一种hash算法，对数据进行摘要计算；

注意：如果接收方比对校验和与发送方不一致，那么数据一定传输有误。但是如果接收方比对校验和与发送方一致，数据**不一定传输成功**。


### 确认应答与序列号
TCP数据包中包含`acknowledge`和`sequence`字段，用于取人应答过程中数据完整已经顺序的保证

* acknowledge：代表下次期望获取到的数据序列
* sequence：代表当前发送的数据起始序列

接收方收到的TCP包中的`acknowledge`代表下次接收方需要发送的`sequence`

在握手期间没有传递数据，但是却增加了`acknowledge`和`sequence`是因为首先这两个字段是相对值，如果没有增加`acknowledge`和`sequence`会导致在重发请求时乱序应答给上次未请求完的逻辑。

